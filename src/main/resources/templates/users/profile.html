<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>User Profile</title>
    <link rel="stylesheet" href="/css/style.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
</head>
<body>
<div th:replace="~{partials/navbar :: navbar}"></div>
<h1>User Profile</h1>
<!-- display details about the current user -->
<h3 th:text="${user.username} ?: 'No username'"></h3>
<p th:text="${user.email} ?: 'No email'"></p>
<p>Dietary Preferences:
    <span th:each="diet, iterStat : ${user.dietaryPreferences}" th:text="${diet.name} + (iterStat.last ? '' : ', ')"></span>
</p>
<p>Allergies:
    <span th:each="allergy : ${user.allergyList}" th:text="${allergy.name} + ', '"></span>
</p>


<!-- Link to create a new recipe -->
<a th:href="@{/recipes/new}" th:if="${currentUser?.username == user.username}">Create Recipe</a>

<!-- Link to favorites page -->
<a th:href="@{/users/{userId}/favorites(userId=${user.id})}" th:if="${currentUser != null}">Favorites</a>
<a th:href="@{/users/{userId}/profile/personal-recipes(userId=${user.id})}">Personal Recipes</a>


<!-- Display the saved recipe details, if available -->
<div th:if="${savedRecipe}">
    <h2>Saved Recipe Details:</h2>
    <p>Title: <span th:text="${savedRecipe.title} ?: 'No title'"></span></p>
</div>
<div th:if="${currentUser?.username == user.username}">
    <h3>Have a nice restaurant experience? Tell everyone a little about it!</h3>
    <div class="nav-item">
        <a th:classappend="${selectedPage == 'posts-create'} ? 'active' : ''" class="nav-link" href="/posts/create" style="padding-right: 0.5rem; padding-left: 0.5rem;">Create Blog Post</a>
    </div>
</div>

<div th:if="${currentUser?.username == user.username}">
    <h3>Your Blog Posts</h3>
    <div th:if="${userPosts}">
        <div th:each="post : ${userPosts}">
            <h4 th:text="${post.title}"></h4>
            <p th:text="${#strings.abbreviate(post.body,200)}"></p>
            <a th:href="@{/posts/{id}(id=${post.id})}">Read More</a>
        </div>
    </div>
</div>

<div th:if="${currentUser?.username != user.username}">
    <h3>Here's what <span th:text="${user.username}"></span> has to say!</h3>
    <div th:if="${userPosts}">
        <div th:each="post : ${userPosts}">
            <h4 th:text="${post.title}"></h4>
            <p th:text="${#strings.abbreviate(post.body,200)}"></p>
            <a th:href="@{/posts/{id}(id=${post.id})}">Read More</a>
        </div>
    </div>
</div>

    &nbsp;
    <a th:href="@{/users/{userId}/posts(userId=${user.id})}">View Post History</a>
</div>
<ul th:if="${mealPlanners}">
    <h2>Meal Planner</h2>
    <li th:each="mealPlanner : ${mealPlanners}">
        <span th:text="${mealPlanner.date} ?: 'No date'"></span>:
        <span th:text="${mealPlanner.recipe.title} ?: 'No recipe title'"></span>
    </li>
</ul>
<div th:if="${param.error}">
    <div th:if="${param.error[0] == 'username'}" class="alert alert-danger">Username is already taken</div>
    <div th:if="${param.error[0] == 'password'}" class="alert alert-danger">Current password is incorrect</div>
</div>

<div th:if="${currentUser?.username == user.username}">
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editUsernameModal">
        Edit Username
    </button>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editPreferencesModal">
        Edit Preferences
    </button>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#changePasswordModal">
        Change Password
    </button>
</div>

<!-- The Edit Diet Modal -->
<div class="modal" id="editPreferencesModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Preferences</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form th:action="@{/profile/edit}" method="POST" th:object="${user}">
                    <div class="form-group">
                        <label for="dietaryPreferences">Dietary Preferences:</label>
                        <select id="dietaryPreferences" th:field="*{dietaryPreferences}" class="form-control">
                            <option th:each="diet : ${allDietStyles}" th:value="${diet.id}" th:text="${diet.name}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="allergyList">Allergies:</label>
                        <div id="allergyList">
                            <div th:each="allergen, stat : ${allAllergens}" class="form-check">
                                <input class="form-check-input" type="checkbox" th:value="${allergen.id}" th:id="${'allergyList[' + stat.index + ']'}" th:field="*{allergyList[__${stat.index}__]}">
                                <label class="form-check-label" th:for="${'allergyList[' + stat.index + ']'}" th:text="${allergen.name}"></label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="otherAllergies">Other Allergies:</label>
                        <input type="text" id="otherAllergies" th:field="*{otherAllergies}" class="form-control"/>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Username Modal -->
<div class="modal" id="editUsernameModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Username</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form th:action="@{/profile/edit-username}" method="POST" th:object="${user}">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" th:field="*{username}" class="form-control"/>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Username</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Password Modal  -->
<div class="modal" id="changePasswordModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Change Password</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form th:action="@{/profile/change-password}" method="POST">
                    <div class="form-group">
                        <label for="currentPassword">Current Password:</label>
                        <input type="password" id="currentPassword" name="currentPassword" class="form-control"/>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" name="newPassword" class="form-control"/>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password:</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" class="form-control"/>
                    </div>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{partials/footer :: footer}"></div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script src="resources/static/javascript/blog.js"></script>
</body>
</html>
