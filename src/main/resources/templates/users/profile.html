<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
    <title>User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
</head>
<body>
<div th:replace="~{partials/navbar :: navbar}"></div>
<h1>User Profile</h1>
<!-- display details about the current user -->
<h3 th:text="${user.username} ?: 'No username'"></h3>
<p th:text="${user.email} ?: 'No email'"></p>
<p th:text="${user.dietaryPreferences} ?: 'No dietary preferences'"></p>
<p th:text="${user.allergyList} ?: 'No allergies'"></p>
<p th:text="${user.otherAllergies} ?: 'No other allergies'"></p>

<!-- Link to create a new recipe -->
<a th:href="@{/recipes/new}" sec:authorize="isAuthenticated()">Create Recipe</a>

<!-- Link to favorites page -->
<a th:href="@{/favorites}" sec:authorize="isAuthenticated()">Favorites</a>
<a th:href="@{/profile/personal-recipes}">Personal Recipes</a>


<!-- Display the saved recipe details, if available -->
<div th:if="${savedRecipe}">
    <h2>Saved Recipe Details:</h2>
    <p>Title: <span th:text="${savedRecipe.title} ?: 'No title'"></span></p>
</div>
<div>
    <h3>Have a nice restaurant experience? Tell everyone a little about it!</h3>
    <div sec:authorize="isAuthenticated()" class="nav-item">
        <a th:classappend="${selectedPage == 'posts-create'} ? 'active' : ''" class="nav-link" href="/posts/create" style="padding-right: 0.5rem; padding-left: 0.5rem;">Create Blog Post</a>

        &nbsp;
    </div>
</div>
<tr th:each="post : ${userPosts}">
    <td><h3 th:text="${post.title}"></h3></td>
    <td><p th:text="${#strings.abbreviate(post.body,200)}"></p></td>
    <td><a th:href="@{/posts/{id}(id=${post.id})}">Read More</a></td>
    <!-- Only show the delete button if the current user is the creator of the recipe -->
    <form th:if="${currentUser.username == post.user.username}" action="#" th:action="@{/posts/{id}(id=${post.id})}" th:method="delete">
        <input type="submit" value="Delete">
    </form>

    <!-- Only show the edit button if the current user is the creator of the recipe -->
    <button th:if="${currentUser.username == post.user.username}" type="button" class="btn btn-primary" data-toggle="modal" data-target="#editPostModal">Edit Post</button>
</tr>
<div>
    &nbsp;
    <a th:href="@{/users/{userId}/posts(userId=${user.id})}">View Post History</a>
</div>
<ul th:if="${mealPlanners}">
    <h2>Meal Planner</h2>
    <li th:each="mealPlanner : ${mealPlanners}">
        <span th:text="${mealPlanner.date} ?: 'No date'"></span>:
        <span th:text="${mealPlanner.recipe.title} ?: 'No recipe title'"></span>
    </li>
</ul>
<div th:if="${param.error}">
    <div th:if="${param.error[0] == 'username'}" class="alert alert-danger">Username is already taken</div>
    <div th:if="${param.error[0] == 'password'}" class="alert alert-danger">Current password is incorrect</div>
</div>

<div th:if="${currentUser?.username == user.username}">
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editUsernameModal">
        Edit Username
    </button>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editPreferencesModal">
        Edit Preferences
    </button>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#changePasswordModal">
        Change Password
    </button>
</div>


<!-- The Edit Diet Modal -->
<div class="modal" id="editPreferencesModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Preferences</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form th:action="@{/profile/edit}" method="POST" th:object="${user}">
                    <div class="form-group">
                        <label for="dietaryPreferences">Dietary Preferences:</label>
                        <input type="text" id="dietaryPreferences" th:field="*{dietaryPreferences}" class="form-control"/>
                    </div>
                    <div class="form-group">
                        <label for="allergyList">Allergies:</label>
                        <div id="allergyList">
                            <div th:each="allergy : ${allAllergies}" class="form-check">
                                <input class="form-check-input" type="checkbox" th:value="${allergy}" th:id="${allergy}" th:field="*{allergyList}">
                                <label class="form-check-label" th:for="${allergy}" th:text="${allergy}"></label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="otherAllergies">Other Allergies:</label>
                        <input type="text" id="otherAllergies" th:field="*{otherAllergies}" class="form-control"/>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editPostModal" tabindex="-1" role="dialog" aria-labelledby="editPostModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRecipeModalLabel">Edit Post</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form th:action="@{'/posts/edit/' + ${post.id}}" th:object="${posts}" method="post">
                    <input type="hidden" name="_method" value="put" />
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" class="form-control" id="title" th:field="*{post.title}" required>
                    </div>
                    <div class="form-group">
                        <label for="body">Body</label>
                        <textarea class="form-control" id="body" th:field="*{post.body}" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

=======
<!-- Username Modal -->
<div class="modal" id="editUsernameModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Username</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form th:action="@{/profile/edit-username}" method="POST" th:object="${user}">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" th:field="*{username}" class="form-control"/>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Username</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Password Modal  -->
<div class="modal" id="changePasswordModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Change Password</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form th:action="@{/profile/change-password}" method="POST">
                    <div class="form-group">
                        <label for="currentPassword">Current Password:</label>
                        <input type="password" id="currentPassword" name="currentPassword" class="form-control"/>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" name="newPassword" class="form-control"/>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password:</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" class="form-control"/>
                    </div>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{partials/footer :: footer}"></div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


<div th:replace="partials/footer :: footer"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script src="resources/static/javascript/blog.js"></script>
</body>
</html>
